"use strict";var Xo=Object.create;var fe=Object.defineProperty,er=Object.defineProperties,tr=Object.getOwnPropertyDescriptor,or=Object.getOwnPropertyDescriptors,rr=Object.getOwnPropertyNames,ge=Object.getOwnPropertySymbols,sr=Object.getPrototypeOf,ze=Object.prototype.hasOwnProperty,nt=Object.prototype.propertyIsEnumerable;var at=(e,t,o)=>t in e?fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,f=(e,t)=>{for(var o in t||(t={}))ze.call(t,o)&&at(e,o,t[o]);if(ge)for(var o of ge(t))nt.call(t,o)&&at(e,o,t[o]);return e},h=(e,t)=>er(e,or(t));var it=(e,t)=>{var o={};for(var r in e)ze.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(e!=null&&ge)for(var r of ge(e))t.indexOf(r)<0&&nt.call(e,r)&&(o[r]=e[r]);return o};var pt=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of rr(t))!ze.call(e,s)&&s!==o&&fe(e,s,{get:()=>t[s],enumerable:!(r=tr(t,s))||r.enumerable});return e};var d=(e,t,o)=>(o=e!=null?Xo(sr(e)):{},pt(t||!e||!e.__esModule?fe(o,"default",{value:e,enumerable:!0}):o,e)),ar=e=>pt(fe({},"__esModule",{value:!0}),e);var n=(e,t,o)=>new Promise((r,s)=>{var a=R=>{try{c(o.next(R))}catch(y){s(y)}},i=R=>{try{c(o.throw(R))}catch(y){s(y)}},c=R=>R.done?r(R.value):Promise.resolve(R.value).then(a,i);c((o=o.apply(e,t)).next())});var da={};module.exports=ar(da);var ic=require("./node_modules/dotenv/config.js"),pc=require("./node_modules/source-map-support/register.js"),Jo=d(require("http"));var v=d(require("./node_modules/express/index.js")),zt=d(require("./node_modules/compression/index.js")),Ft=d(require("./node_modules/helmet/dist/esm/index.js")),$t=d(require("./node_modules/cors/lib/index.js"));var mt=require("./node_modules/zod/lib/index.mjs");var be=require("./node_modules/debug/src/index.js"),he=(0,be.debug)("info"),Re=(0,be.debug)("error"),Pe=(0,be.debug)("warn");var nr=(e,t,o)=>{t?he(o||"%j",e,t):he(o||"%j",e)},ir=(e,t,o)=>{t?Re(o||"%o",e,t):Re(o||"%o",e)},pr=(e,t,o)=>{t?Pe(o||"%j",e,t):Pe(o||"%j",e)},k={info:nr,err:ir,warn:pr};var ct=require("./node_modules/multer/index.js"),Z={VALIDATION_ERROR:"Validation Error",INTERNAL_ERROR:"Internal Error",FORBIDDEN:"Forbidden",NOT_FOUND:"Not Found",UNAUTHORIZED:"Unauthorized"},U=class extends Error{constructor(o,r,s){super(o);this.status=500;this.message=o,this.status=r,this.validationError=s}},w=class extends U{constructor(o){super(typeof o=="string"?o:Z.VALIDATION_ERROR,400,typeof o!="string"?o:void 0);this.status=400;this.message=typeof o=="string"?o:Z.VALIDATION_ERROR,this.validationError=typeof o!="string"?o:void 0,this.name=this.constructor.name}},ye=class extends U{constructor(o=Z.INTERNAL_ERROR){super(o,500);this.status=500;this.message=o,this.name=this.constructor.name}},m=class extends U{constructor(o=Z.FORBIDDEN){super(o,403);this.status=403;this.message=o,this.name=this.constructor.name}},g=class extends U{constructor(o=Z.NOT_FOUND){super(o,404);this.status=404;this.message=o,this.name=this.constructor.name}},N=class extends U{constructor(o=Z.UNAUTHORIZED){super(o,401);this.status=401;this.message=o,this.name=this.constructor.name}},ut=(e,t,o,r)=>{let s=e;(s==null?void 0:s.type)==="entity.parse.failed"&&(s=new U("entity.parse.failed",413)),s instanceof mt.ZodError&&(s=new w(s.issues)),s instanceof ct.MulterError&&(s=new w(s.message)),(s instanceof ye||!(s instanceof U))&&k.err(s.message,s.stack),s instanceof U||(s=new ye),o.status(s.status).send({message:s.message,validationError:s.validationError})};var ke=d(require("./node_modules/jsonwebtoken/index.js")),F=(e,t,o)=>{let r=(t?process.env.JWT_ADMIN_SECRET:process.env.JWT_SECRET)||"";if(!(!r||r===""))return ke.default.sign(e,r,o)},dt=e=>ke.default.decode(e),we=(e,t)=>{let o=(t?process.env.JWT_ADMIN_SECRET:process.env.JWT_SECRET)||"";return ke.default.verify(e,o)};var Fe=d(require("./node_modules/express-async-handler/index.js"));var p={USER:"user",ADMIN:"admin",PRO:"pro"},lt={TEXT:"text",PHOTO:"photo"},l={CANCELLED:"cancelled",REJECTED:"rejected",ACCEPTED:"accepted",COMPLETED:"completed",PENDING:"pending"},I={EMAIL:"email",PHONE:"phone"};var gt="https://"+process.env.STORAGE_ENDPOINT,Se="https://hairsap."+process.env.STORAGE_ENDPOINT_CDN+"/",ba={DAILY:5e4*100,MONTHLY:125e3*100,WEEKLY_EARNING:125e3*100,WEEKLY_BONUS:25e3*100,WEEKLY_BONUS_QUOTA:375e3*100},ft="https://api.paystack.co";var S=({repo:e})=>(0,Fe.default)((t,o,r)=>n(void 0,null,function*(){let s=t.headers.authorization;if(!s)throw new N;s=s.replace(/Bearer /g,"");let a=dt(s);try{we(s,(a==null?void 0:a.role)===p.ADMIN)}catch(c){throw new N}let i=yield e.user.getUserById(a==null?void 0:a.userId);if(!i)throw new N;if([p.PRO,p.USER].includes(a==null?void 0:a.role)&&!i.verified)throw new m("user not verified");if((a==null?void 0:a.role)===p.PRO){if(i.terminated)throw new m("pro terminated");if(i.deactivated&&t.baseUrl+t.path!=="/reactivate/request")throw new m("pro deactivated")}t.tokenData=a,r()})),b=e=>(0,Fe.default)((t,o,r)=>n(void 0,null,function*(){if(!e.includes(t.tokenData.role))throw new m;r()}));var Ye=d(require("./node_modules/swagger-ui-express/index.js"));var ht={openapi:"3.0.0",components:{responses:{InternalError:{required:["message"],properties:{message:{type:"string",default:"Internal Error"}}},ValidationError:{required:["message"],properties:{message:{type:"string",default:"Validation Error"},validationError:{type:"array",minimum:1,items:{type:"object",properties:{code:{type:"string",example:"too small"},minimum:{type:"number",example:2},type:{type:"string",example:"string"},inclusive:{type:"boolean",example:!0},message:{type:"string",example:"Should be at least 2 characters"},path:{type:"array",items:{type:"string",example:"example"}}}}}}},ForbiddenError:{required:["message"],properties:{message:{type:"string",default:"Forbidden"}}},NotFoundError:{required:["message"],properties:{message:{type:"string",default:"Not Found"}}},UnauthorizedError:{required:["message"],properties:{message:{type:"string",default:"Unauthorized"}}},Success:{properties:{data:{type:{oneOf:[{type:"array"},{type:"object"}]},default:"Ok"}}}},schemas:{AuthLoginRequest:{type:"object",required:["email","password"],properties:{email:{type:"string",description:"unique user email",example:"john@hairsap.com"},password:{type:"string",description:"card type, either virtual or physical",example:"john1234",minimum:7,maximum:32}}},AuthLoginResponse:{type:"object",required:["token"],properties:{token:{type:"string",description:"a JWT token",example:"1592BB17-8B6E-4CA7-AAC2-8140E7BF19AC"}}}},securitySchemes:{BearerAuth:{type:"http",scheme:"bearer"}}},info:{title:"Hairsap-api",description:"Hairsap API",version:"v1.0.0"},servers:[{url:"http://localhost:4000",description:"development"}],paths:{"/auth/login":{post:{operationId:"postAuthLogin",description:"allows a user to login",tags:["Auth"],requestBody:{content:{"application/json":{schema:{$ref:"#/components/schemas/AuthLoginRequest"}}}},parameters:[],responses:{"201":{description:"Status 201 Response",content:{"application/json":{schema:{$ref:"#/components/schemas/AuthLoginResponse"}}}},"400":{description:"Status 400 Response",content:{"application/json":{schema:{$ref:"#/components/responses/ValidationError"}}}},"500":{description:"Status 500 Response",content:{"application/json":{schema:{$ref:"#/components/responses/InternalError"}}}}}}}}};var te=d(require("./node_modules/express-async-handler/index.js")),Et=d(require("crypto"));var $e=d(require("./node_modules/dayjs/dayjs.min.js")),Rt=d(require("./node_modules/dayjs/plugin/duration.js"));$e.default.extend(Rt.default);var u=$e.default;var Pt=require("crypto");var B=e=>(0,Pt.createHmac)("sha256",process.env.DATA_ENCRYPTION_KEY||"").update(e).digest("hex");var Ie=e=>Math.round(e)*100;var Ee=require("./node_modules/zod/lib/index.mjs"),_=Ee.z.object({perPage:Ee.z.number().optional().default(20),page:Ee.z.number().optional().default(1)}).strict();var M=e=>{let t=_.parse(e);return h(f({},t),{skip:(t.page-1)*t.perPage})},j=({total:e,skip:t,perPage:o,page:r})=>({total:e,skipped:t,perPage:o,page:r,pageCount:Math.ceil(e/o)});var cr=1e3,bt=e=>{let t=u.duration({milliseconds:e*cr}).as("ms");return u().add(t,"ms").toDate()};var $=d(require("./node_modules/bull/index.js"));var wt=d(require("./node_modules/nodemailer/lib/nodemailer.js")),yt=Number(process.env.MAIL_PORT||0),kt=wt.default.createTransport({host:process.env.MAIL_HOST,port:yt,secure:process.env.MAIL_SECURE==="true"||yt===465,auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),St=kt.sendMail.bind(kt);var It=require("./node_modules/@prisma/client/index.js"),ur=new It.PrismaClient({log:process.env.NODE_ENV==="development"?["query"]:[]}),ie=ur;var X=process.env.REDIS_URL,dr=new $.default("main",X),O=new $.default("email",X),ee=new $.default("phone",X),Ke=new $.default("payment",X),He=new $.default("chat",X),Va=new $.default("payment_threshold",X);dr.process((e,t)=>n(void 0,null,function*(){k.info(e.id,e.data),t()}));O.process((e,t)=>n(void 0,null,function*(){if(process.env.NODE_ENV!=="production")return t();St(e.data).then(o=>{t()}).catch(o=>{k.err(o.message),t()})}));ee.process((e,t)=>n(void 0,null,function*(){if(process.env.NODE_ENV!=="production")return t()}));He.process((e,t)=>n(void 0,null,function*(){if(process.env.NODE_ENV!=="production")return t();yield ie.chat.create({data:e.data})}));Ke.process((e,t)=>n(void 0,null,function*(){var o;yield ie.paymentEvents.create({data:e.data}),(o=e.data)==null||o.event,t()}));var We=require("./node_modules/zod/lib/index.mjs");var vt=d(require("./node_modules/got/dist/source/index.js"));var lr=({router:e,service:t,repo:o})=>(e.get("/",(0,te.default)((r,s)=>{s.send("welcome to hairsap")})),e.post("/webhook/paystack",(0,te.default)((r,s)=>{let a=process.env.PAYMENT_SECRET;if(Et.default.createHmac("sha512",a).update(JSON.stringify(r.body)).digest("hex")!==r.headers["x-paystack-signature"])throw k.info(r.body),new m;Ke.add({userId:null,event:r.body.event,reason:r.body.reason,data:r.body.data}),s.sendStatus(200)})),e.get("/verify_transaction",S({repo:o}),(0,te.default)((r,s)=>n(void 0,null,function*(){We.z.object({reference:We.z.string()}).parse({reference:r.query.reference});let{data:a}=yield(0,vt.default)(ft+"/transaction/verify/"+r.query.reference,{headers:{Authorization:"Bearer "+process.env.PAYSTACK_SECRET}}).json();k.info(a),s.sendStatus(200)}))),e.get("/services",S({repo:o}),(0,te.default)((r,s)=>n(void 0,null,function*(){let a=yield t.other.getServices();s.status(200).send({data:a})}))),e.get("/notifications",S({repo:o}),(0,te.default)((r,s)=>n(void 0,null,function*(){var i;let a=yield t.other.getNotifications((i=r.tokenData)==null?void 0:i.userId);s.status(200).send({data:a})}))),e),At=lr;var K=d(require("./node_modules/express-async-handler/index.js"));var gr=({router:e,service:t,repo:o})=>(e.post("/login",(0,K.default)((r,s)=>n(void 0,null,function*(){let a=yield t.auth.login(r.body);s.status(200).send({data:a})}))),e.post("/signup",(0,K.default)((r,s)=>n(void 0,null,function*(){let a=yield t.auth.signUp(r.body);s.status(200).send({data:a})}))),e.post("/generateotp",S({repo:o}),b([p.USER,p.PRO]),(0,K.default)((r,s)=>n(void 0,null,function*(){let a=yield t.auth.generateOtp(r.body);s.status(200).send({data:a})}))),e.post("/validateotp",S({repo:o}),b([p.USER,p.PRO]),(0,K.default)((r,s)=>n(void 0,null,function*(){let a=yield t.auth.validateOtp(r.body);s.status(200).send({data:a})}))),e.post("/resetpassword",(0,K.default)((r,s)=>n(void 0,null,function*(){yield t.auth.resetPassword(r.body),s.status(201).send()}))),e.post("/confirmresetpassword",(0,K.default)((r,s)=>n(void 0,null,function*(){yield t.auth.confirmResetPassword(r.body),s.status(201).send()}))),e),Ut=gr;var oe=d(require("./node_modules/express-async-handler/index.js")),Je=require("./node_modules/nanoid/index.js");var Ot=d(require("./node_modules/multer/index.js")),xt=d(require("./node_modules/multer-s3/index.js")),ve=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js");var qt=d(require("path"));var Ct=new ve.S3Client({endpoint:gt,credentials:{accessKeyId:process.env.STORAGE_KEY,secretAccessKey:process.env.STORAGE_SECRET}}),Nt=({source:e,key:t})=>{Ct.send(new ve.CopyObjectCommand({Bucket:"hairsap",CopySource:e,Key:t,ACL:"public-read"}))},Bt=1024*1024,pe=({getKey:e,type:t,acl:o="private"})=>(0,Ot.default)({storage:(0,xt.default)({s3:Ct,bucket:"hairsap",acl:o,key:(r,s,a)=>{a(null,e(s,r))}}),limits:{fileSize:t==="image"?10*Bt:30*Bt},fileFilter:(r,s,a)=>{if(t==="image"){let i=/jpeg|jpg|png|gif/;if(!i.test(qt.default.extname(s.originalname).toLowerCase()))return a(new w("file must be an image"));if(!i.test(s.mimetype))return a(new w("file must be an image"))}a(null,!0)}});var Tt=({service:e})=>(t,o)=>n(void 0,null,function*(){var r;yield e.user.updateUser((r=t.tokenData)==null?void 0:r.userId,t.body),o.sendStatus(201)});var fr=({router:e,service:t})=>(e.patch("/",b([p.USER]),(0,oe.default)(Tt({service:t}))),e.post("/faceid",pe({getKey:(o,r)=>{var s;return`faceid/pro/${(s=r.tokenData)==null?void 0:s.userId}/${(0,Je.nanoid)()}/${o.originalname}`},type:"image"}).single("faceid"),(0,oe.default)((o,r)=>n(void 0,null,function*(){var a,i;let s=yield t.auth.uploadFaceId({userId:(a=o.tokenData)==null?void 0:a.userId,role:o.tokenData.role,proId:(i=o.tokenData)==null?void 0:i.userId,faceIdPhotoKey:o.file.key,faceIdPhotoOriginalFileName:o.file.originalname});r.status(200).send({data:s})}))),e.post("/profilephoto",b([p.USER]),pe({getKey:(o,r)=>{var s;return`profilephoto/user/${(s=r.tokenData)==null?void 0:s.userId}/${(0,Je.nanoid)()}/${o.originalname}`},type:"image",acl:"public-read"}).single("profilephoto"),(0,oe.default)((o,r)=>n(void 0,null,function*(){let s=yield t.user.uploadProfilePhoto({userId:o.tokenData.userId,profilePhotoKey:o.file.key,profilePhotoOriginalFileName:o.file.originalname,profilePhotoUrl:Se+o.file.key});r.status(200).send({data:s})}))),e.post("/subscribe",b([p.USER]),(0,oe.default)((o,r)=>n(void 0,null,function*(){var s;yield t.user.subscribe({userId:(s=o.tokenData)==null?void 0:s.userId,proId:o.body.proId}),r.sendStatus(201)}))),e.post("/subscriptions",b([p.USER]),(0,oe.default)((o,r)=>n(void 0,null,function*(){var a;let s=yield t.user.getUserSubscriptions({userId:(a=o.tokenData)==null?void 0:a.userId});r.status(200).send({data:s})}))),e),Dt=fr;var Ve=d(require("./node_modules/express-async-handler/index.js"));var hr=({router:e,service:t})=>(e.get("/",(0,Ve.default)((o,r)=>n(void 0,null,function*(){var a;let s=yield t.chat.getChatList((a=o.tokenData)==null?void 0:a.userId);r.send({data:s})}))),e.post("/",(0,Ve.default)((o,r)=>n(void 0,null,function*(){let s=yield t.chat.getChatById({userId:o.tokenData.userId,otherUserId:o.body.userId,cursor:o.body.cursor,desc:o.body.desc,take:o.body.take});r.send({data:s})}))),e),Lt=hr;var H=d(require("./node_modules/express-async-handler/index.js"));var Rr=({router:e,service:t})=>(e.patch("/",b([p.PRO]),(0,H.default)((o,r)=>n(void 0,null,function*(){let s=yield t.pro.updatePro(o.tokenData.userId,o.body);r.status(200).send({data:s})}))),e.post("/auto",(0,H.default)((o,r)=>n(void 0,null,function*(){let s=yield t.pro.getNearestPro({latitude:o.body.latitude,longitude:o.body.longitude,subServiceId:o.body.subServiceId,distance:o.body.distance,userId:o.body.userId});r.status(200).send({data:s})}))),e.post("/verify:id",(0,H.default)((o,r)=>n(void 0,null,function*(){var s;yield t.pro.verifyPro({userId:+o.params.userId,role:(s=o.tokenData)==null?void 0:s.role}),r.status(201).send()}))),e.post("/reactivate/request",(0,H.default)((o,r)=>n(void 0,null,function*(){var s,a;yield t.pro.requestReactivation({userId:(s=o.tokenData)==null?void 0:s.userId,role:(a=o.tokenData)==null?void 0:a.role}),r.status(201).send()}))),e.get("/subscribers",b([p.PRO]),(0,H.default)((o,r)=>n(void 0,null,function*(){var a;let s=yield t.pro.getProSubscribers({proId:(a=o.tokenData)==null?void 0:a.userId});r.status(200).send({data:s})}))),e.get("/services/:proId",(0,H.default)((o,r)=>n(void 0,null,function*(){let s=yield t.pro.getProServices({proId:+o.params.proId});r.status(200).send({data:s})}))),e),_t=Rr;var x=d(require("./node_modules/express-async-handler/index.js"));var Mt=require("./node_modules/nanoid/index.js");var Pr=({router:e,service:t})=>(e.post("/",pe({getKey:(o,r)=>{var s;return`samplephoto/user/${(s=r.tokenData)==null?void 0:s.userId}/${(0,Mt.nanoid)()}/${o.originalname}`},type:"image",acl:"public-read"}).fields([{name:"payload",maxCount:1},{name:"samplePhoto",maxCount:1}]),(0,x.default)((o,r)=>n(void 0,null,function*(){var R;let s;try{if(s=JSON.parse(o.body.payload),typeof s!="object")throw new Error("Unexpected end of JSON input")}catch(y){throw new w(y.message)}let i=o.files.samplePhoto[0],c=yield t.book.bookPro({userId:(R=o.tokenData)==null?void 0:R.userId,proId:s.proId,subServiceId:s.subServiceId,latitude:s.latitude,longitude:s.longitude,address:s.address,samplePhotoKey:i.key,samplePhotoOriginalFileName:i.originalname,samplePhotoUrl:Se+i.key});r.status(200).send({data:c})}))),e.get("/accepted",(0,x.default)((o,r)=>n(void 0,null,function*(){var a;let s=yield t.book.getAcceptedProBookings({userId:(a=o.tokenData)==null?void 0:a.userId});r.status(200).send({data:s})}))),e.patch("/:id/add",(0,x.default)((o,r)=>n(void 0,null,function*(){var s;yield t.book.addServiceToBooking({subServiceId:o.body.subServiceId,bookingId:o.body.bookingId,userId:(s=o.tokenData)==null?void 0:s.userId}),r.status(201).send()}))),e.post("/:id/accept",(0,x.default)((o,r)=>n(void 0,null,function*(){var s,a;yield t.book.acceptBooking({bookingId:+o.params.id,userId:(s=o.tokenData)==null?void 0:s.userId,role:(a=o.tokenData)==null?void 0:a.role}),r.status(201).send()}))),e.post("/:id/cancel",(0,x.default)((o,r)=>n(void 0,null,function*(){var s,a;yield t.book.cancelBooking({bookingId:+o.params.id,userId:(s=o.tokenData)==null?void 0:s.userId,role:(a=o.tokenData)==null?void 0:a.role}),r.status(201).send()}))),e.post("/:id/reject",b([p.PRO]),(0,x.default)((o,r)=>n(void 0,null,function*(){var a;let s=yield t.book.rejectBooking({bookingId:+o.params.id,userId:(a=o.tokenData)==null?void 0:a.userId});r.status(200).send({data:s})}))),e.post("/:id/:role/completed",(0,x.default)((o,r)=>n(void 0,null,function*(){var s,a,i,c;o.params.role===p.USER?yield t.book.markBookingAsUserCompleted({bookingId:+o.params.id,userId:(s=o.tokenData)==null?void 0:s.userId,role:(a=o.tokenData)==null?void 0:a.role}):yield t.book.markBookingAsProCompleted({bookingId:+o.params.id,proId:(i=o.tokenData)==null?void 0:i.proId,role:(c=o.tokenData)==null?void 0:c.role}),r.status(201).send()}))),e.post("/:id/arrived",b([p.PRO]),(0,x.default)((o,r)=>n(void 0,null,function*(){var s;yield t.book.markBookingAsArrived({bookingId:+o.params.id,proId:(s=o.tokenData)==null?void 0:s.proId}),r.status(201).send()}))),e.get("/activity/:userId",b([p.PRO]),(0,x.default)((o,r)=>n(void 0,null,function*(){let s=yield t.book.getUncompletedBookings({userId:+o.params.userId});r.status(200).send({data:s})}))),e),jt=Pr;var q=d(require("./node_modules/express-async-handler/index.js"));var br=({router:e,service:t})=>(e.post("/reactivate/accept/:userId",(0,q.default)((o,r)=>n(void 0,null,function*(){var s;yield t.admin.acceptReactivation({userId:+o.params.userId,role:(s=o.tokenData)==null?void 0:s.role}),r.status(201).send()}))),e.post("/payout/requests",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.admin.getPayoutRequests(o.body);r.status(200).send(s)}))),e.post("/proapplication/:userId/:action",(0,q.default)((o,r)=>n(void 0,null,function*(){yield t.admin.acceptOrRejectApplication({action:o.params.action,userId:+o.params.userId}),r.sendStatus(201)}))),e.post("/pros",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.pro.getAllPros({name:o.body.name,serviceId:o.body.serviceId,page:o.body.page,perPage:o.body.perPage});r.status(200).send({data:s})}))),e.post("/users",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.user.getAllUsers({name:o.body.name,userId:o.body.userId,page:o.body.page,perPage:o.body.perPage});r.status(200).send({data:s})}))),e.post("/userdetails",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.user.getUserDetails({userId:o.body.userId});r.status(200).send({data:s})}))),e.post("/prodetails",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.pro.getProDetails({userId:o.body.userId});r.status(200).send({data:s})}))),e.post("/userbookings",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.book.getUserBookings({userId:o.body.userId,page:o.body.page,perPage:o.body.perPage});r.status(200).send({data:s})}))),e.post("/probookings",(0,q.default)((o,r)=>n(void 0,null,function*(){let s=yield t.book.getProBookings({proId:o.body.proId,status:o.body.status,period:o.body.period});r.status(200).send({data:s})}))),e),Gt=br;var yr=({repo:e,service:t})=>{let o=(0,v.default)();return o.use((0,zt.default)()),o.use((0,Ft.default)()),o.use(v.default.json()),o.use((0,$t.default)({origin:"*"})),o.use("/reference",Ye.default.serve,Ye.default.setup(ht)),o.use("/auth",Ut({router:(0,v.Router)(),service:t,repo:e})),o.use("/users",S({repo:e}),Dt({router:(0,v.Router)(),service:t})),o.use("/pros",S({repo:e}),_t({router:(0,v.Router)(),service:t})),o.use("/chats",S({repo:e}),Lt({router:(0,v.Router)(),service:t})),o.use("/bookings",S({repo:e}),jt({router:(0,v.Router)(),service:t})),o.use("/admin",S({repo:e}),b([p.ADMIN]),Gt({router:(0,v.Router)(),service:t})),o.use("/",At({router:(0,v.Router)(),service:t,repo:e})),o.use(ut),o},Kt=yr;var T=require("./node_modules/zod/lib/index.mjs");var Ht=T.z.object({createdAt:T.z.string().refine(e=>e.match(new RegExp(/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/))),text:T.z.string().optional(),photo:T.z.string().optional(),message:T.z.string().optional(),senderId:T.z.number(),receiverId:T.z.number(),messageType:T.z.nativeEnum(lt)}).strict();var Ae={},kr={},wr=({io:e,service:t})=>{e.use(function(o,r){var s,a,i;if(((s=o.handshake.query)==null?void 0:s.token)&&((a=o.handshake.query)==null?void 0:a.role))try{let c=we(o.handshake.query.token,((i=o.handshake.query)==null?void 0:i.role)===p.ADMIN);o.decodedToken=c,r()}catch(c){r(new N)}else r(new N)}),e.on("connection",o=>{k.info("a user connected"),process.env.NODE_ENV==="development"&&o.onAny((r,...s)=>{k.info({event:r,args:s})}),o.on("disconnect",()=>{Ae[o.decodedToken.userId]=void 0,k.info("user disconnected")}),o.on("setup",({userId:r,proId:s})=>{r&&(Ae[r]={socketId:o.id}),s&&(kr[s]={socketId:o.id})}),o.on("new message",r=>{var i,c;if(!Ht.safeParse(r).success)return;He.add(r),((i=Ae[r.receiverId])==null?void 0:i.socketId)&&o.to((c=Ae[r.receiverId])==null?void 0:c.socketId).emit("new message",r)}),o.on("bookpro",r=>n(void 0,null,function*(){try{let s=yield t.book.bookPro(h(f({},r),{userId:o.decodedToken.userId}));o.emit("bookpro",{data:s})}catch(s){o.emit("bookpro",{error:s.message})}}))})},Wt=wr;var Vo=require("./node_modules/socket.io/wrapper.mjs");var Sr=({db:e})=>t=>e.booking.findUnique({where:{bookingId:t}}),Ir=({db:e})=>(t,o)=>e.booking.findMany({where:{proId:t,status:o}}),Er=({db:e})=>(t,o)=>e.booking.findMany({where:{proId:t,status:{in:o}}}),vr=({db:e})=>(t,o,r)=>e.booking.findMany({where:{proId:t,status:r}}),Ar=({db:e})=>({userId:t,status:o,subServiceId:r})=>e.booking.findMany({where:{AND:[{userId:t,status:o},{bookedSubServices:{some:{subService:{service:{subServices:{some:{subServiceId:r}}}}}}}]}}),Ur=({db:e})=>a=>n(void 0,[a],function*({subService:{subServiceId:t,name:o,price:r},bookingId:s}){e.booking.update({data:{bookedSubServices:{create:{subServiceId:t}},invoice:{update:{invoiceFees:{create:{name:o,price:r}}}}},where:{bookingId:s}})}),Br=({db:e})=>t=>e.booking.create({data:{address:t.address,status:l.PENDING,userId:t.userId,proId:t.proId,arrivalAt:t.arrivalAt,samplePhotoUrl:t.samplePhotoUrl,samplePhotoKey:t.samplePhotoKey,samplePhotoOriginalFileName:t.samplePhotoOriginalFileName,bookedSubServices:{create:{subServiceId:t.subServiceId}},invoice:{create:{distance:t.distance,transportFee:t.transportFee,invoiceFees:{create:{name:t.subServiceName,price:t.subServiceFee}}}}},include:{invoice:{select:{invoiceId:!0}}}}),Or=({db:e})=>t=>e.subService.findUnique({where:{subServiceId:t}}),xr=({db:e})=>(t,o)=>e.booking.update({data:o,where:{bookingId:t}}),qr=({db:e})=>(t,o)=>e.$transaction([e.booking.count({where:{userId:t},take:o.perPage,skip:o.skip}),e.booking.findMany({where:{userId:t},take:o.perPage,skip:o.skip})]),Cr=({db:e})=>s=>n(void 0,[s],function*({period:t,proId:o,status:r}){let a=yield e.booking.groupBy({by:["proId","userId"],where:{proId:o,status:l.COMPLETED,createdAt:{gte:u().startOf(t).toDate()}},having:{userId:r==="new"?{lt:2}:{gt:1}},_count:!0}),c=(yield e.$transaction(a.map(({proId:y,userId:Q})=>e.invoiceFees.findMany({where:{invoice:{booking:{userId:Q,proId:y}}},select:{feeId:!0,name:!0,price:!0,createdAt:!0}})))).flat(),R=c.reduce((y,Q)=>y+Q.price,0);return{count:(a==null?void 0:a[0]._count)||0,services:c,total:R}}),Nr=({db:e})=>({bookPro:Br({db:e}),getSubService:Or({db:e}),addServiceToBooking:Ur({db:e}),getBookingById:Sr({db:e}),updateBooking:xr({db:e}),getProBookingsByStatus:Ir({db:e}),getProBookingsByStatuses:Er({db:e}),getProBookingsByProIdAndUserId:vr({db:e}),getUserBookingsBySubService:Ar({db:e}),getUserBookings:qr({db:e}),getProBookings:Cr({db:e})}),Jt=Nr;var Tr=({db:e})=>t=>e.$queryRaw`
  SELECT userId,name,photoUrl FROM (SELECT DISTINCT 
    CASE 
    WHEN senderId = ${t} THEN receiverId 
    WHEN receiverId = ${t} THEN senderId
    END as id
  FROM Chat) temp
  INNER JOIN User ON userId = id 
  WHERE id is not NULL`,Dr=({db:e})=>({userId:t,otherUserId:o,cursor:r,take:s=20,desc:a=!1})=>e.chat.findMany({take:a?-s:s,skip:1,cursor:r?{chatId:r}:void 0,where:{OR:[{senderId:t,receiverId:o},{senderId:o,receiverId:t}]},orderBy:{createdAt:"desc"}}),Lr=({db:e})=>({getChatList:Tr({db:e}),getChatById:Dr({db:e})}),Vt=Lr;var me=require("./node_modules/@prisma/client/index.js");var _r=({db:e})=>s=>n(void 0,[s],function*({latitude:t,longitude:o,proId:r}){var i;let a=yield e.$queryRaw`
    SELECT ST_distance_sphere(
              POINT(longitude, latitude),
              POINT(${o}, ${t})
          ) AS distance
    FROM User
    WHERE userId = ${r}
    `;return(i=a==null?void 0:a[0])==null?void 0:i.distance}),Mr=({db:e})=>i=>n(void 0,[i],function*({latitude:t,longitude:o,subServiceId:r,distance:s,userId:a}){let c=yield e.$queryRaw`
    SELECT * FROM (SELECT
    u.userId,
    u.businessName,
    u.name proName,
    ss.name serviceName,
    u.address,
    ss.price,
    ss.subServiceId,
            u.role,
            longitude,
            latitude, (
        ST_distance_sphere(
            POINT(longitude, latitude),
            POINT(${o}, ${t})
        )
    ) AS distance
FROM User as u
    INNER JOIN ProService us ON u.userId = us.proId
    INNER JOIN subService ss ON us.serviceId = ss.serviceId) as sub
WHERE
    subServiceId = ${r}
    ${s?me.Prisma.sql`AND distance >= ${s}
    AND ( distance > ${s} 
      ${a?me.Prisma.sql`OR userId > ${a}`:me.Prisma.empty}
     )`:me.Prisma.empty}
    AND longitude IS NOT NULL
    AND latitude IS NOT NULL
    AND available = 1
ORDER BY distance, userId ASC LIMIT 1;`;return c==null?void 0:c[0]}),jr=({db:e})=>t=>e.user.findMany({take:t.perPage,skip:t.skip}),Gr=({db:e})=>t=>e.$transaction([e.user.count({}),e.user.findMany({take:t.perPage,skip:t.skip})]),zr=({db:e})=>t=>e.subscription.findMany({where:{proId:t},include:{users:{select:{userId:!0,profilePhotoUrl:!0,name:!0}}}}),Fr=({db:e})=>t=>e.service.findFirst({where:{proServices:{some:{proId:t}}},include:{subServices:!0}}),$r=({db:e})=>({serviceId:t,name:o})=>{let r={role:p.PRO,proServices:{some:{serviceId:t}},name:{contains:o}};return e.$transaction([e.user.count({where:r}),e.user.findMany({where:r})])},Kr=({db:e})=>o=>n(void 0,[o],function*({proId:t}){let[r,s,a,i,c,R,y,Q,st,ae,ne,Ge]=yield e.$transaction([e.booking.findMany({where:{proId:t,createdAt:{gte:u().startOf("day").toDate()}},orderBy:{createdAt:"desc"},include:{bookedSubServices:{select:{subService:!0}}}}),e.invoiceFees.aggregate({_sum:{price:!0},where:{invoice:{booking:{proId:t}},createdAt:{gte:u().startOf("date").toDate()}}}),e.booking.count({where:{proId:t,createdAt:{gte:u().startOf("date").toDate()}}}),e.invoiceFees.aggregate({_sum:{price:!0},where:{invoice:{booking:{proId:t}},createdAt:{gte:u().startOf("week").toDate()}}}),e.booking.count({where:{proId:t,createdAt:{gte:u().startOf("week").toDate()}}}),e.invoiceFees.aggregate({_sum:{price:!0},where:{invoice:{booking:{proId:t}},createdAt:{gte:u().startOf("month").toDate()}}}),e.booking.count({where:{proId:t,createdAt:{gte:u().startOf("month").toDate()}}}),e.invoiceFees.aggregate({_sum:{price:!0},where:{invoice:{booking:{proId:t}}}}),e.booking.count({where:{proId:t}}),e.subscription.count({where:{proId:t}}),e.booking.aggregate({where:{proId:t},_avg:{rating:!0}}),e.user.findFirst({where:{userId:t},include:{account:!0,proServices:{where:{proId:t},include:{service:!0}}}})]);return{latestBookings:r,dailyBookingCount:a,dailyBookingSum:s._sum.price,weeklyBookingCount:c,weeklyBookingSum:i._sum.price,monthlyBookingCount:y,monthlyBookingSum:R._sum.price,allBookingCount:st,allBookingSum:Q._sum.price,subscriptions:ae,averageRatings:ne._avg.rating,user:Ge}}),Hr=({db:e})=>({getNearestPro:Mr({db:e}),getDistBtwLoctions:_r({db:e}),getPayoutRequests:jr({db:e}),getPayoutRequestsWP:Gr({db:e}),getProSubscribers:zr({db:e}),getProServices:Fr({db:e}),getAllPros:$r({db:e}),getProDetails:Kr({db:e})}),Yt=Hr;var Wr=({db:e})=>t=>e.user.findUnique({where:{userId:t},include:{otp:!0}}),Jr=({db:e})=>t=>e.user.findUnique({where:{userId:t},include:{otp:!0}}),Vr=({db:e})=>t=>e.user.findFirst({where:{email:t}}),Yr=({db:e})=>t=>e.user.findFirst({where:{phone:t}}),Qr=({db:e})=>(t,o)=>e.user.findUnique({where:{email_role:{email:t,role:o}}}),Zr=({db:e})=>(t,o)=>e.user.findUnique({where:{phone_role:{phone:t,role:o}}}),Xr=({user:e,db:t})=>t.user.create({data:e}),es=({db:e})=>t=>e.user.delete({where:{userId:t}}),ts=({db:e})=>(t,o)=>e.user.update({data:o,where:{userId:t}}),os=({db:e})=>({userId:t,proId:o})=>e.subscription.create({data:{proId:o,userId:t}}),rs=({db:e})=>t=>e.subscription.findMany({where:{userId:t},include:{pros:{select:{userId:!0,profilePhotoUrl:!0,name:!0}}}}),ss=({db:e})=>({userId:t,name:o})=>{let r={role:p.USER,userId:t,name:{contains:o}};return e.$transaction([e.user.count({where:r}),e.user.findMany({where:r})])},as=({db:e})=>o=>n(void 0,[o],function*({userId:t}){let[r,s,a,i,c]=yield e.$transaction([e.booking.count({where:{userId:t}}),e.subscription.count({where:{userId:t}}),e.booking.aggregate({where:{userId:t},_avg:{rating:!0}}),e.invoiceFees.aggregate({_sum:{price:!0},where:{invoice:{booking:{userId:t}},paid:!0}}),e.user.findFirst({where:{userId:t}})]);return{totalBookings:r,subscriptions:s,averageRatings:a._avg.rating,amountSpent:i._sum.price,user:c}}),ns=({db:e})=>({getUserById:Wr({db:e}),getUserByIdAndOtp:Jr({db:e}),getUserByEmail:Vr({db:e}),getUserByPhone:Yr({db:e}),getUserByEmailAndRole:Qr({db:e}),getUserByPhoneAndRole:Zr({db:e}),createUser:t=>Xr({user:t,db:e}),updateUser:ts({db:e}),deleteUser:es({db:e}),subscribe:os({db:e}),getUserSubscriptions:rs({db:e}),getAllUsers:ss({db:e}),getUserDetails:as({db:e})}),Qt=ns;var is=({db:e})=>()=>e.service.findMany({include:{subServices:!0}}),ps=({db:e})=>t=>e.notification.findMany({take:20,orderBy:{createdAt:"asc"},where:{userId:t}}),ms=({db:e})=>({getServices:is({db:e}),getNotifications:ps({db:e})}),Zt=ms;var cs=({db:e})=>({userId:t,expiredAt:o,token:r})=>e.passwordReset.create({data:{userId:t,expiredAt:o,token:r}}),us=({db:e})=>({userId:t,token:o})=>e.passwordReset.findUnique({where:{userId_token:{token:o,userId:t}}}),ds=({db:e})=>(t,o)=>e.passwordReset.delete({where:{userId_token:{token:o,userId:t}}}),ls=({db:e})=>({resetPassword:cs({db:e}),getResetPasswordToken:us({db:e}),deleteResetPasswordToken:ds({db:e})}),Xt=ls;var gs=({db:e})=>({user:Qt({db:e}),chat:Vt({db:e}),pro:Yt({db:e}),book:Jt({db:e}),other:Zt({db:e}),auth:Xt({db:e})}),eo=gs;var A=require("./node_modules/zod/lib/index.mjs");var ce=A.z.object({email:A.z.string().email().optional(),phone:A.z.string().min(0).optional(),password:A.z.string().min(6).max(32)}).strict(),to=ce.extend({role:A.z.literal(p.ADMIN)}).strict().superRefine(({email:e,phone:t},o)=>{!e&&!t&&o.addIssue({code:A.z.ZodIssueCode.custom,path:["email","phone"],message:"email or phone must be provided"})}),oo=ce.extend({role:A.z.literal(p.USER)}).strict().superRefine(({email:e,phone:t},o)=>{!e&&!t&&o.addIssue({code:A.z.ZodIssueCode.custom,path:["email","phone"],message:"email or phone must be provided"})}),ro=ce.extend({role:A.z.literal(p.PRO)}).strict().superRefine(({email:e,phone:t},o)=>{!e&&!t&&o.addIssue({code:A.z.ZodIssueCode.custom,path:["email","phone"],message:"email or phone must be provided"})});var P=require("./node_modules/zod/lib/index.mjs");var D=P.z.object({address:P.z.string().min(2),email:P.z.string().email(),name:P.z.string(),photoUrl:P.z.string().optional().nullable(),userId:P.z.number(),phone:P.z.string(),role:P.z.nativeEnum(p),profilePhotoUrl:P.z.string().optional().nullable(),terminated:P.z.boolean().optional().nullable(),deactivated:P.z.boolean().optional().nullable(),deactivatedReason:P.z.string().optional().nullable(),reactivationRequested:P.z.boolean().optional().nullable(),verified:P.z.boolean().optional().nullable(),available:P.z.boolean().optional().nullable(),workVideoUrl:P.z.string().optional().nullable(),businessName:P.z.string().optional().nullable()}).passthrough().strict().strip();var re="email or phone number or password incorrect",fs=o=>n(void 0,[o],function*({repo:e,body:t}){to.parse(t);let r;if(t.email&&(r=yield e.user.getUserByEmailAndRole(t.email,t.role)),t.phone&&(r=yield e.user.getUserByEmailAndRole(t.phone,t.role)),!r)throw new m(re);let s=B(t.password);if(r.password!==s)throw new m(re);let a=F({email:r.email,role:r.role,userId:r.userId},!0,{expiresIn:String(u.duration({days:7}).as("ms"))});return{admin:D.parse(r),token:a}}),hs=o=>n(void 0,[o],function*({repo:e,body:t}){oo.parse(t);let r;if(t.email&&(r=yield e.user.getUserByEmailAndRole(t.email,t.role)),t.phone&&(r=yield e.user.getUserByPhoneAndRole(t.phone,t.role)),!r)throw new m(re);let s=B(t.password);if(r.password!==s)throw new m(re);if(!r.verified)throw new m("account not verified");let a=F({email:r.email,role:r.role,userId:r.userId},!1,{expiresIn:String(u.duration({days:30}).as("ms"))});return{user:D.parse(r),token:a}}),Rs=o=>n(void 0,[o],function*({repo:e,body:t}){ro.parse(t);let r;if(t.email&&(r=yield e.user.getUserByEmailAndRole(t.email,t.role)),t.phone&&(r=yield e.user.getUserByEmailAndRole(t.phone,t.role)),!r)throw new m(re);let s=B(t.password);if(r.password!==s)throw new m(re);if(!r.verified)throw new m("account not verified");let a=F({email:r.email,role:r.role,userId:r.userId},!1,{expiresIn:String(u.duration({days:30}).as("ms"))});return{pro:D.parse(r),token:a}}),so=({repo:e})=>t=>{let o=t.role===p.ADMIN,r=t.role===p.USER,s=t.role===p.PRO;if(o)return fs({repo:e,body:t});if(s)return Rs({repo:e,body:t});if(r)return hs({repo:e,body:t});throw new m};var Qe=e=>({from:'"Hairsap" <notify@hairsap.com>',to:"admin@hairsap.com",subject:"New SignUp",text:`A new user with name ${e} has signed up`,html:`<p>A new user with name ${e} has signed up</p>`}),ue=({email:e,name:t,otp:o})=>({from:'"Hairsap" <notify@hairsap.com>',to:e,subject:"Your OTP Code",text:`Dear ${t},
 Please use the OTP code: ${o} to complete your login.`,html:`<p>Dear ${t},
 Please use the OTP code: ${o} to complete your login.</p>`});var E=require("./node_modules/zod/lib/index.mjs"),ao=E.z.object({email:E.z.string().email(),name:E.z.string(),password:E.z.string().min(6).max(32),phone:E.z.string().min(8),address:E.z.string().min(2),otpType:E.z.nativeEnum(I).optional()}).strict(),no=ao.extend({role:E.z.literal(p.USER)}).strict(),io=ao.extend({businessName:E.z.string(),role:E.z.literal(p.PRO),serviceId:E.z.number()}).strict();var po=d(require("crypto")),W=(e=6)=>new Promise(t=>po.default.randomBytes(3,(o,r)=>{let s=parseInt(r.toString("hex"),16).toString().substring(0,e);t(String(s))}));var Ps=(e,t)=>n(void 0,null,function*(){no.parse(t);let o=yield e.user.getUserByEmail(t.email),r=yield e.user.getUserByPhone(t.phone);if(o&&o.role===p.USER)throw new w("user with this email already exists");if(r&&r.role===p.USER)throw new w("user with this phone number already exists");let s=B(t.password),a;t.otpType&&(a=yield W());let i=yield e.user.createUser(h(f({},t),{password:s,otp:a?{create:{value:a,expiredAt:u().add(10,"m").toDate()}}:void 0}));O.add(Qe(i.name));let c=F({email:i.email,role:i.role,userId:i.userId},!1,{expiresIn:String(u.duration({days:30}).as("ms"))});return a&&(t.otpType===I.PHONE&&ee.add({phone:i.phone,otp:a}),t.otpType===I.EMAIL&&O.add(ue({name:i.name,email:i.email,otp:a}))),{user:D.parse(i),otp:a,token:c}}),bs=(e,t)=>n(void 0,null,function*(){io.parse(t);let o=yield e.user.getUserByEmail(t.email),r=yield e.user.getUserByPhone(t.phone);if(o&&o.role===p.PRO)throw new w("pro with this email already exists");if(r&&r.role===p.PRO)throw new w("pro with this phone number already exists");let s=B(t.password),a;t.otpType&&(a=yield W());let i=yield e.user.createUser(h(f({},t),{password:s,otp:a?{create:{value:a,expiredAt:u().add(10,"m").toDate()}}:void 0}));O.add(Qe(i.name));let c=F({email:i.email,role:i.role,userId:i.userId},!1,{expiresIn:String(u.duration({days:30}).as("ms"))});return a&&(t.otpType===I.PHONE&&ee.add({phone:i.phone,otp:a}),t.otpType===I.EMAIL&&O.add(ue({name:i.name,email:i.email,otp:a}))),{pro:D.parse(i),otp:a,token:c}}),mo=({repo:e})=>t=>{if(t.role===p.USER)return Ps(e,t);if(t.role===p.PRO)return bs(e,t);throw new m};var Ue=require("./node_modules/zod/lib/index.mjs"),co=Ue.z.object({otp:Ue.z.string().min(6),userId:Ue.z.number()}).strict();var uo=({repo:e})=>t=>n(void 0,null,function*(){var r,s;co.parse(t);let o=yield e.user.getUserById(t.userId);if(!o)throw new m;if(!((r=o.otp)!=null&&r.value))throw new m;if(o.otp.value!==t.otp)throw new m;if(u((s=o==null?void 0:o.otp)==null?void 0:s.expiredAt).isBefore(u()))throw new m;return yield e.user.updateUser(o.userId,{otp:{delete:!0},verified:!0}),D.parse(o)});var lo=({email:e,token:t})=>({from:'"Hairsap" <notify@hairsap.com>',to:e,subject:"New SignUp",text:`A password reset has been initiated. Please use this token ${t} which expires in 1 hour`,html:`A password reset has been initiated. Please use this token ${t} which expires in 1 hour`});var J=require("./node_modules/zod/lib/index.mjs");var Be=J.z.object({token:J.z.string().min(1),role:J.z.nativeEnum(p),email:J.z.string().email(),expiredAt:J.z.date(),userId:J.z.number()}).merge(ce.pick({password:!0})).strict();var go=({repo:e})=>t=>n(void 0,null,function*(){Be.parse(t);let o=yield W();yield e.auth.resetPassword({userId:t.userId,expiredAt:u().add(1,"hour").toDate(),token:o}),O.add(lo({email:t.email,token:o}))});var fo=({repo:e})=>t=>n(void 0,null,function*(){Be.parse(t);let o=yield e.auth.getResetPasswordToken(t);if(!o)throw new m("token expired");if(u(o.expiredAt).isBefore(u()))throw new m("token expired");let r=B(t.password);yield e.user.updateUser(t.userId,{password:r})});var ho=require("./node_modules/nanoid/index.js");var ys=s=>n(void 0,[s],function*({repo:e,body:{userId:t,faceIdPhotoKey:o,faceIdPhotoOriginalFileName:r}}){yield e.user.updateUser(t,{faceIdPhotoKey:o,faceIdPhotoOriginalFileName:r})}),ks=s=>n(void 0,[s],function*({repo:e,body:{proId:t,faceIdPhotoKey:o,faceIdPhotoOriginalFileName:r}}){yield Nt({source:"/hairsap/"+o,key:`profilephoto/pro/${t}/${(0,ho.nanoid)()}/${r}`}),yield e.user.updateUser(t,{faceIdPhotoKey:o,faceIdPhotoOriginalFileName:r})}),Ro=({repo:e})=>i=>n(void 0,[i],function*({userId:t,proId:o,role:r,faceIdPhotoKey:s,faceIdPhotoOriginalFileName:a}){if(o)return ks({repo:e,body:{proId:o,role:r,faceIdPhotoKey:s,faceIdPhotoOriginalFileName:a}});if(t)return ys({repo:e,body:{userId:t,role:r,faceIdPhotoKey:s,faceIdPhotoOriginalFileName:a}})});var Oe=require("./node_modules/zod/lib/index.mjs");var Po=Oe.z.object({otpType:Oe.z.nativeEnum(I),userId:Oe.z.number()}).strict();var bo=({repo:e})=>t=>n(void 0,null,function*(){Po.parse(t);let o=yield W(),r=yield e.user.getUserById(t.userId);throw r?(yield e.user.updateUser(t.userId,{otp:{create:{value:o,expiredAt:u().add(10,"m").toDate()}}}),t.otpType===I.PHONE&&ee.add({phone:r.phone,otp:o}),t.otpType===I.EMAIL&&O.add(ue({name:r.name,email:r.email,otp:o})),new m):new m});var ws=({repo:e})=>({login:so({repo:e}),signUp:mo({repo:e}),validateOtp:uo({repo:e}),uploadFaceId:Ro({repo:e}),confirmResetPassword:fo({repo:e}),resetPassword:go({repo:e}),generateOtp:bo({repo:e})}),yo=ws;var qe=require("./node_modules/zod/lib/index.mjs");var de=require("./node_modules/zod/lib/index.mjs"),xe=de.z.object({cursor:de.z.number().optional(),take:de.z.number().optional(),desc:de.z.boolean().optional()}).strict();var ko=qe.z.object({userId:qe.z.number().min(1),otherUserId:qe.z.number().min(1)}).strict().merge(xe);var Ss=({repo:e})=>t=>n(void 0,null,function*(){return{chats:yield e.chat.getChatList(t)}}),Is=({repo:e})=>t=>n(void 0,null,function*(){return ko.parse(t),{chats:yield e.chat.getChatById(t)}}),Es=({repo:e})=>({getChatList:Ss({repo:e}),getChatById:Is({repo:e})}),wo=Es;var et=require("./node_modules/zod/lib/index.mjs");var Ce=require("./node_modules/zod/lib/index.mjs"),So=Ce.z.object({userId:Ce.z.number().optional(),name:Ce.z.string().optional()}).strict();var Ze=require("./node_modules/zod/lib/index.mjs"),Io=Ze.z.object({userId:Ze.z.number()}).strict();var Ne=require("./node_modules/zod/lib/index.mjs"),Xe=Ne.z.object({userId:Ne.z.number(),address:Ne.z.string().min(1)}).strict(),Fp=Xe.extend({});var Te=require("./node_modules/zod/lib/index.mjs"),Eo=Te.z.object({userId:Te.z.number(),proId:Te.z.number()}).strict();var se=require("./node_modules/zod/lib/index.mjs"),vo=se.z.object({userId:se.z.number(),profilePhotoKey:se.z.string(),profilePhotoOriginalFileName:se.z.string(),profilePhotoUrl:se.z.string()}).strict();var vs=({repo:e})=>(t,o)=>n(void 0,null,function*(){Xe.parse(h(f({},o),{userId:t})),yield e.user.updateUser(t,o)}),As=({repo:e})=>t=>n(void 0,null,function*(){return Eo.parse(t),yield e.user.subscribe(t)}),Us=({repo:e})=>t=>n(void 0,null,function*(){return Io.parse(t),yield e.user.getUserSubscriptions(t.userId)}),Bs=({repo:e})=>t=>n(void 0,null,function*(){vo.parse(t);let{userId:o,profilePhotoKey:r,profilePhotoOriginalFileName:s,profilePhotoUrl:a}=t;yield e.user.updateUser(o,{profilePhotoKey:r,profilePhotoOriginalFileName:s,profilePhotoUrl:a})}),Os=({repo:e})=>t=>n(void 0,null,function*(){So.parse(t);let{perPage:o,page:r}=t,s=M({perPage:o,page:r}),[a,i]=yield e.user.getAllUsers(h(f({},t),{skip:s.skip}));return{meta:j(h(f({},s),{total:a})),data:i}}),xs=({repo:e})=>t=>n(void 0,null,function*(){et.z.object({userId:et.z.number()}).strict().parse(t);let{totalBookings:o,subscriptions:r,averageRatings:s,amountSpent:a,user:i}=yield e.user.getUserDetails(t);return{totalBookings:o,subscriptions:r,averageRatings:s,amountSpent:a,user:i}}),qs=({repo:e})=>({updateUser:vs({repo:e}),subscribe:As({repo:e}),getUserSubscriptions:Us({repo:e}),uploadProfilePhoto:Bs({repo:e}),getAllUsers:Os({repo:e}),getUserDetails:xs({repo:e})}),Ao=qs;var Y=require("./node_modules/zod/lib/index.mjs");var De=require("./node_modules/zod/lib/index.mjs");var Uo=De.z.object({serviceId:De.z.number().optional(),name:De.z.string().optional()}).merge(_).strict();var G=require("./node_modules/zod/lib/index.mjs"),Bo=G.z.object({userId:G.z.number(),address:G.z.string().min(1),available:G.z.boolean(),accountNumber:G.z.string(),accountName:G.z.string(),bankName:G.z.string()});var V=require("./node_modules/zod/lib/index.mjs"),Oo=V.z.object({subServiceId:V.z.number(),latitude:V.z.number().refine(e=>Math.abs(e)<=90),longitude:V.z.number().refine(e=>Math.abs(e)<=180),userId:V.z.number().optional(),distance:V.z.number().optional()}).strict();var Cs=({repo:e})=>(t,o)=>n(void 0,null,function*(){Bo.parse(h(f({},o),{userId:t})),yield e.user.updateUser(t,o)}),Ns=({repo:e})=>t=>n(void 0,null,function*(){Oo.parse(t);let o=yield e.pro.getNearestPro(t);if(!o)return;let r=Ie(o.distance),s=o.price;return delete o.distance,delete o.price,{pro:o,transportation:r,total:s+r}}),Ts=({repo:e})=>r=>n(void 0,[r],function*({userId:t,role:o}){if(o!==p.ADMIN)throw new m;let s=yield e.user.getUserById(t);if(!s)throw new g("pro not found");if(s.verified)throw new m("pro is already verified");yield e.user.updateUser(t,{verified:!0})}),Ds=({repo:e})=>r=>n(void 0,[r],function*({userId:t,role:o}){if(o!==p.PRO)throw new m;let s=yield e.user.getUserById(t);if(!s)throw new g("pro not found");if(s.reactivationRequested)throw new m("reactivation already requested");yield e.user.updateUser(t,{reactivationRequested:!0})}),Ls=({repo:e})=>o=>n(void 0,[o],function*({proId:t}){return Y.z.object({proId:Y.z.number()}).parse({proId:t}),yield e.pro.getProSubscribers(t)}),_s=({repo:e})=>o=>n(void 0,[o],function*({proId:t}){return Y.z.object({proId:Y.z.number()}).parse({proId:t}),yield e.pro.getProServices(t)}),Ms=({repo:e})=>t=>n(void 0,null,function*(){Uo.parse(t);let{perPage:o,page:r}=t,s=M({perPage:o,page:r}),[a,i]=yield e.pro.getAllPros(h(f({},t),{skip:s.skip}));return{meta:j(h(f({},s),{total:a})),data:i}}),js=({repo:e})=>t=>n(void 0,null,function*(){return Y.z.object({userId:Y.z.number()}).strict().parse(t),yield e.pro.getProDetails({proId:t.userId})}),Gs=({repo:e})=>({getNearestPro:Ns({repo:e}),verifyPro:Ts({repo:e}),requestReactivation:Ds({repo:e}),getProSubscribers:Ls({repo:e}),getProServices:_s({repo:e}),getAllPros:Ms({repo:e}),getProDetails:js({repo:e}),updatePro:Cs({repo:e})}),xo=Gs;var rt=require("./node_modules/zod/lib/index.mjs");var tt=require("./node_modules/zod/lib/index.mjs");var qo=tt.z.object({userId:tt.z.number()}).strict().merge(xe);var C=require("./node_modules/zod/lib/index.mjs"),Co=C.z.object({proId:C.z.number(),status:C.z.union([C.z.literal("new"),C.z.literal("completed")]),period:C.z.union([C.z.literal("day"),C.z.literal("week"),C.z.literal("month")])}).strict();var ot=require("./node_modules/zod/lib/index.mjs");var No=ot.z.object({userId:ot.z.number()}).merge(_).strict();var le=require("./node_modules/zod/lib/index.mjs"),To=le.z.object({subServiceId:le.z.number(),bookingId:le.z.number(),userId:le.z.number()}).strict();var Le=require("./node_modules/zod/lib/index.mjs"),_e=Le.z.object({userId:Le.z.number(),bookingId:Le.z.number()}).strict();var z=require("./node_modules/zod/lib/index.mjs"),Do=z.z.object({subServiceId:z.z.number(),latitude:z.z.number().refine(e=>Math.abs(e)<=90),longitude:z.z.number().refine(e=>Math.abs(e)<=180),userId:z.z.number(),proId:z.z.number(),address:z.z.string().min(5)}).strict();var Me=require("./node_modules/zod/lib/index.mjs"),Lo=Me.z.object({proId:Me.z.number(),bookingId:Me.z.number()}).strict();var L=require("./node_modules/zod/lib/index.mjs");var _o=L.z.object({userId:L.z.number(),bookingId:L.z.number(),role:L.z.literal(p.USER)}).strict(),Mo=L.z.object({proId:L.z.number(),bookingId:L.z.number(),role:L.z.literal(p.PRO)}).strict();var zs=({repo:e})=>a=>n(void 0,null,function*(){var i=a,{samplePhotoOriginalFileName:t,samplePhotoKey:o,samplePhotoUrl:r}=i,s=it(i,["samplePhotoOriginalFileName","samplePhotoKey","samplePhotoUrl"]);let{longitude:c,latitude:R}=s;Do.parse(s);let y=yield e.user.getUserById(s.proId);if(!(y!=null&&y.available))throw new m("Pro is not available");if((yield e.book.getProBookingsByStatus(s.proId,l.ACCEPTED)).length>1)throw new m("pro currently busy");if((yield e.book.getUserBookingsBySubService({subServiceId:s.subServiceId,userId:s.userId,status:l.ACCEPTED})).length)throw new m("user has existing booking with service");let[ae,ne]=yield Promise.all([e.pro.getDistBtwLoctions({latitude:R,longitude:c,proId:s.proId}),e.book.getSubService(s.subServiceId)]);if(!ne)throw new g("subService does not exist");let Ge=bt(ae);return yield e.book.bookPro(h(f({},s),{distance:ae,subServiceFee:ne.price,subServiceName:ne.name,transportFee:Ie(ae),arrivalAt:Ge,samplePhotoOriginalFileName:t,samplePhotoKey:o,samplePhotoUrl:r}))}),Fs=({repo:e})=>t=>n(void 0,null,function*(){To.parse(t);let o=yield e.book.getBookingById(t.bookingId);if(!o||o.userId!==t.userId)throw new g("booking not found");if(o.status!==l.ACCEPTED&&o.status!==l.PENDING)throw new g("Service can no longer be added to booking");let r=yield e.book.getSubService(t.subServiceId);if(!r)throw new g("service not found");yield e.book.addServiceToBooking({subService:r,bookingId:t.bookingId,userId:t.userId})}),$s=({repo:e})=>s=>n(void 0,[s],function*({userId:t,bookingId:o,role:r}){if(_e.parse({userId:t,bookingId:o}),r!==p.PRO)throw new m("Booking can only be accepted by pro");let[a,i]=yield Promise.all([e.book.getProBookingsByStatus(t,l.PENDING),e.book.getProBookingsByStatus(t,l.ACCEPTED)]);if(i.length>1)throw new m("too many accepted bookings");if(!a.find(R=>R.bookingId===o))throw new g("booking not found");yield e.book.updateBooking(o,{acceptedAt:new Date,status:l.ACCEPTED})}),Ks=({repo:e})=>s=>n(void 0,[s],function*({userId:t,bookingId:o,role:r}){if(_e.parse({userId:t,bookingId:o}),r!==p.USER)throw new m("Booking can only be accepted by pro");let a=yield e.book.getBookingById(o);if(!a||a.userId!==t)throw new g("booking not found");if(a.status!==l.PENDING)throw new g("Booking cannot be cancelled");yield e.book.updateBooking(o,{cancelledAt:new Date,status:l.CANCELLED})}),Hs=({repo:e})=>r=>n(void 0,[r],function*({userId:t,bookingId:o}){_e.parse({userId:t,bookingId:o});let s=yield e.book.getBookingById(o);if(!s||s.userId!==t)throw new g("booking not found");if(s.status!==l.PENDING&&s.status!==l.ACCEPTED)throw new g("Booking cannot be rejected");yield e.book.updateBooking(o,{status:l.REJECTED,rejectedAt:new Date})}),Ws=({repo:e})=>s=>n(void 0,[s],function*({userId:t,bookingId:o,role:r}){_o.parse({userId:t,bookingId:o,role:r});let a=yield e.book.getBookingById(o);if(!a||a.userId!==t)throw new g("booking not found");if(a.status!==l.ACCEPTED)throw new g("Booking cannot be rejected");if(a.userCompleted)throw new m("booking already marked as completed");yield e.book.updateBooking(o,{userCompleted:!0,status:a.proCompleted?l.COMPLETED:void 0})}),Js=({repo:e})=>s=>n(void 0,[s],function*({proId:t,bookingId:o,role:r}){Mo.parse({proId:t,bookingId:o,role:r});let a=yield e.book.getBookingById(o);if(!a||a.proId!==t)throw new g("booking not found");if(a.status!==l.ACCEPTED)throw new g("Booking cannot be rejected");if(a.proCompleted)throw new m("booking already marked as completed");yield e.book.updateBooking(o,{proCompleted:!0,status:a.userCompleted?l.COMPLETED:void 0})}),Vs=({repo:e})=>r=>n(void 0,[r],function*({proId:t,bookingId:o}){Lo.parse({proId:t,bookingId:o});let s=yield e.book.getBookingById(o);if(!s||s.proId!==t)throw new g("booking not found");if(s.status!==l.ACCEPTED)throw new g("Booking has not been accepted");if(s.arrived)throw new m("booking already marked as arrived");yield e.book.updateBooking(o,{arrived:!0})}),Ys=({repo:e})=>o=>n(void 0,[o],function*({userId:t}){return qo.parse({userId:t}),yield e.book.getProBookingsByStatus(t,l.ACCEPTED)}),Qs=({repo:e})=>o=>n(void 0,[o],function*({userId:t}){return rt.z.object({userId:rt.z.number()}).parse({userId:t}),yield e.book.getProBookingsByStatuses(t,[l.ACCEPTED,l.PENDING])}),Zs=({repo:e})=>t=>n(void 0,null,function*(){No.parse(t);let{page:o,perPage:r}=t,s=M({page:o,perPage:r}),[a,i]=yield e.book.getUserBookings(t.userId,s);return{meta:j(h(f({},s),{total:a})),data:i}}),Xs=({repo:e})=>t=>n(void 0,null,function*(){return Co.parse(t),yield e.book.getProBookings(t)}),ea=({repo:e})=>({bookPro:zs({repo:e}),addServiceToBooking:Fs({repo:e}),acceptBooking:$s({repo:e}),rejectBooking:Hs({repo:e}),getAcceptedProBookings:Ys({repo:e}),cancelBooking:Ks({repo:e}),markBookingAsUserCompleted:Ws({repo:e}),markBookingAsProCompleted:Js({repo:e}),markBookingAsArrived:Vs({repo:e}),getUncompletedBookings:Qs({repo:e}),getUserBookings:Zs({repo:e}),getProBookings:Xs({repo:e})}),jo=ea;var Go=require("./node_modules/zod/lib/index.mjs");var zo=Go.z.object({}).merge(_).strict();var je=require("./node_modules/zod/lib/index.mjs"),ta={accept:"accept",reject:"reject"},Fo=je.z.object({userId:je.z.number(),action:je.z.nativeEnum(ta)}).strict();var oa=({repo:e})=>o=>n(void 0,[o],function*({userId:t}){let r=yield e.user.getUserById(t);if(!r)throw new g("pro not found");if(!r.reactivationRequested)throw new m("reactivation not requested");if(!r.deactivated)throw new m("pro already active");yield e.user.updateUser(t,{reactivationRequested:!1,deactivated:!1,reactivationCount:{increment:1}})}),ra=({repo:e})=>t=>n(void 0,null,function*(){zo.parse(t);let o=M(t),[r,s]=yield e.pro.getPayoutRequestsWP(o);return{meta:j(h(f({},o),{total:r})),data:s}}),sa=({repo:e})=>t=>n(void 0,null,function*(){Fo.parse(t);let{action:o,userId:r}=t;o==="accept"?yield e.user.updateUser(r,{verified:!0}):yield e.user.deleteUser(r)}),aa=({repo:e})=>({acceptReactivation:oa({repo:e}),getPayoutRequests:ra({repo:e}),acceptOrRejectApplication:sa({repo:e})}),$o=aa;var na=({repo:e})=>()=>e.other.getServices(),ia=({repo:e})=>t=>e.other.getNotifications(t),pa=({repo:e})=>({getServices:na({repo:e}),getNotifications:ia({repo:e})}),Ko=pa;var ma=({repo:e})=>({auth:yo({repo:e}),user:Ao({repo:e}),chat:wo({repo:e}),pro:xo({repo:e}),book:jo({repo:e}),admin:$o({repo:e}),other:Ko({repo:e})}),Ho=ma;var Yo=eo({db:ie}),Qo=Ho({repo:Yo}),ca=Kt({repo:Yo,service:Qo}),Zo=Jo.default.createServer(ca),ua=new Vo.Server(Zo,{cors:{origin:"*"}});Wt({io:ua,service:Qo});var Wo=process.env.PORT||4e3;Zo.listen(Wo,()=>{k.info("listening on port "+Wo)});
//# sourceMappingURL=out.js.map
